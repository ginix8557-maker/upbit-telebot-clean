name: Keep Render Alive
on:
  schedule:
    - cron: "*/10 * * * *"   # 10ë¶„ë§ˆë‹¤
  workflow_dispatch:

concurrency:
  group: keepalive
  cancel-in-progress: true

permissions:
  contents: read

env:
  # ê¸°ë³¸ê°’: ì €ìž¥ì†Œ ë³€ìˆ˜ê°€ ì—†ìœ¼ë©´ ì´ ê°’ ì‚¬ìš©
  RENDER_URL: ${{ vars.RENDER_URL || 'https://upbit-telebot-clean.onrender.com/' }}
  # ì„ íƒ: ì„±ê³µ ì‹œì—ë„ ì•Œë¦¼ ë³´ë‚´ë ¤ë©´ ì €ìž¥ì†Œ ë³€ìˆ˜ ENABLE_SUCCESS_NOTIFY=true ë¡œ ì„¤ì •
  ENABLE_SUCCESS_NOTIFY: ${{ vars.ENABLE_SUCCESS_NOTIFY || 'false' }}
  # ì„ íƒ: ì•Œë¦¼ ì ‘ë‘ì‚¬(ë¸Œëžœë“œëª… ë“±)
  ALERT_PREFIX: ${{ vars.ALERT_PREFIX || '' }}
  # ë„¤íŠ¸ì›Œí¬ íŠœë‹
  CURL_TIMEOUT: "7"     # ì´ˆ
  RETRIES: "3"          # ìž¬ì‹œë„ íšŸìˆ˜

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Render with retries
        id: ping
        shell: bash
        run: |
          url="${RENDER_URL%/}/"   # ë³´ìž¥ëœ ìŠ¬ëž˜ì‹œ
          ok=1
          for i in $(seq 1 "${RETRIES}"); do
            start=$(date +%s%3N)
            code=$(curl -A "keepalive-gh-actions" -s -o /dev/null -w "%{http_code}" --max-time "${CURL_TIMEOUT}" "$url") || code=000
            end=$(date +%s%3N)
            ms=$((end-start))
            echo "try#$i -> $url => HTTP $code (${ms}ms)"
            if [ "$code" = "200" ]; then
              echo "http_code=$code" >> "$GITHUB_OUTPUT"
              echo "latency_ms=$ms" >> "$GITHUB_OUTPUT"
              ok=0
              break
            fi
            sleep 5
          done
          exit $ok

      - name: Telegram alert on failure
        if: failure()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
          URL:      ${{ env.RENDER_URL }}
          PREFIX:   ${{ env.ALERT_PREFIX }}
        run: |
          prefix="${PREFIX:+$PREFIX }"
          msg="${prefix}ðŸš¨ Render ping ì‹¤íŒ¨\nURL: ${URL}\nWorkflow: ${GITHUB_WORKFLOW} (#${GITHUB_RUN_NUMBER})\nBranch: ${GITHUB_REF_NAME}"
          curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            --data-urlencode text="${msg}" >/dev/null || true

      - name: Telegram notice on success (optional)
        if: success() && env.ENABLE_SUCCESS_NOTIFY == 'true'
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
          URL:      ${{ env.RENDER_URL }}
          PREFIX:   ${{ env.ALERT_PREFIX }}
          PING_MS:  ${{ steps.ping.outputs.latency_ms }}
        run: |
          prefix="${PREFIX:+$PREFIX }"
          ms="${PING_MS:-N/A}"
          msg="${prefix}âœ… Render ping OK (${ms}ms)\nURL: ${URL}\nWorkflow: ${GITHUB_WORKFLOW} (#${GITHUB_RUN_NUMBER})"
          curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            --data-urlencode text="${msg}" >/dev/null || true
