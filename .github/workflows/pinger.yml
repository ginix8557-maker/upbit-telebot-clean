name: Keep Render Alive

on:
  schedule:
    - cron: "*/5 * * * *"   # 5ë¶„ë§ˆë‹¤
  workflow_dispatch:

permissions:
  contents: read

env:
  RENDER_URL: ${{ vars.RENDER_URL || 'https://upbit-telebot-clean.onrender.com/' }}
  MAX_RETRY: 3

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Ping Render with retries
        id: ping
        run: |
          url="${RENDER_URL%/}/"
          echo "Target: $url"
          ok=0
          for i in $(seq 1 "$MAX_RETRY"); do
            echo "try #$i"
            code=$(curl -A "keepalive-gh-actions" -s -o /dev/null -w "%{http_code}" --max-time 25 "$url" || echo 000)
            echo "HTTP $code"
            if [ "$code" = "200" ]; then
              ok=1
              break
            fi
            sleep 10
          done
          if [ "$ok" -ne 1 ]; then
            echo "Ping failed after ${MAX_RETRY} tries"
            exit 1
          fi

      - name: Notify Telegram on failure
        if: failure()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
          URL:      ${{ env.RENDER_URL }}
        run: |
          msg="ðŸš¨ Render ping ì—°ì† ì‹¤íŒ¨\nURL: ${URL}\nWorkflow: ${GITHUB_WORKFLOW} (#${GITHUB_RUN_NUMBER})"
          curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            --data-urlencode text="${msg}" >/dev/null || true
